---
title: "RxODE"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
#load packages
require(learnr)
require(knitr)
require(png)
require(grid)
library(cowplot)
library(ggplot2)

#options
knitr::opts_chunk$set(echo = FALSE)

#load data used in exercises

```

## Introduction

Understanding of pharmacokinetics (PK) and pharmacodynamics (PD) is essential before using the package RxODE. If the concept of compartmental modelling is not clear to you, first go back to PKPD lectures. A system of ordinary differential equations (ODEs) describe PKPD models, with equations for the change of amount of drug over time in different compartments. This is done for the example below, where a depot and central compartment are shown and the corresponding ODEs. The drug is only leaving compartment 1, the depot, which results in only one negative term in the ODE. Compartment 2, the central compartment has drug which enters from the depot, and drug which leaves the compartment. Therefore, we see two terms in the ODE, one positive term describing the amount coming in and one negative term describing the amount going out over time. 

```{r fig1, echo = FALSE, out.width = "100%", fig.asp = 0.7, fig.cap = "**Figure 1: Example of a model and its ODEs**"}
img <- readPNG("./Images/Model_ODE.png")
grid.raster(img)
```

### Purpose and installation

RxODE is a package designed for simulation with already established models with ODEs. This tutorial focuses on using this package for pharmacometric models, such as the PKPD models. The model that you are going to simulate with RxODE is probably already published, but at least the model already has estimations for its parameters, since you cannot estimate parameters with RxODE. Pharmacometric models which are usually developed in NONMEN can easily be translated. 

Installation is very easy, as it is a package placed on CRAN. Before you install it, first check if it is already in your library, especially if you are working on the RStudio server. RxODE sometimes runs into errors or problems when it is used within a local RStudio, therefore, some research groups choose to use an RStudio server for your project with RxODE. 

### Test your knowledge

```{r fig2, fig.show = "hold", out.width = "100%", fig.cap = "**Figure 2: Four different PK model schematics**"}
p1 <- ggdraw() + draw_image("./Images/comp1.png")
p2 <- ggdraw() + draw_image("./Images/comp1_oral.png")
p3 <- ggdraw() + draw_image("./Images/comp2_oral.png")
p4 <- ggdraw() + draw_image("./Images/comp3.png")


plot_grid(p1, p2, p3, p4, nrow  = 2, ncol = 2, labels = "AUTO")
```

```{r quiz1, echo = FALSE}
quiz(caption = "Quiz - PK models and ODEs",
  question("Look at Figure 2 above. Which type of drug administration is used in each model? IV = intravascular, EV = extravascular, for example oral.",
    answer("A: IV, B: EV, C: EV, D: EV", message = "If no depot or Ka (absorption constant) is shown, we assume the dose was directly administered to the central compartment."),
    answer("A: IV, B: IV, C: IV, D: EV", message = "A depot indicates and Ka (absorption constant) indicate the dose was administered out the blood, and has to absorbe into the blood."),
    answer("A: IV, B: EV, C: EV, D: IV", correct = TRUE),
    answer("A: IV, B: IV, C: EV, D: IV", message = "A depot indicates and Ka (absorption constant) indicate the dose was administered out the blood, and has to absorbe into the blood."),
    allow_retry = TRUE
  ),
  question("Again, with Figure 2 in mind, which ODE of the central compartment is correct for which model? *Ad = amount in depot, Ac is amount in central compartment, Ap1 is amount in peripheral 1, Ap2 is amount in peripheral 2.* <br/> ODE1: $\\frac{dAc}{dt} = Ka*Ad - \\frac{CL}{V}*Ac - K12*Ac + K21*Ap1$         <br/> ODE2: $\\frac{dAc}{dt} = - \\frac{CL}{V}*Ac$ <br/> ODE3: $\\frac{dAc}{dt} = - \\frac{CL}{V}*Ac - K12*Ac + K21*Ap1 - K13*Ac + K31*Ap2$ <br/> ODE4: $\\frac{dAc}{dt} = Ka*Ad - \\frac{CL}{V}*Ac$",
    answer("A: ODE4, B: ODE2, C: ODE3, D: ODE1", message = "Count all the arrows going to and from the central compartment. This is how many terms you should have in your ODE."),
    answer("A: ODE3, B: ODE1, C: ODE2, D: ODE4", message = "Count all the arrows going to and from the central compartment. This is how many terms you should have in your ODE."),
    answer("A: ODE1, B: ODE3, C: ODE4, D: ODE2", message = "Count all the arrows going to and from the central compartment. This is how many terms you should have in your ODE."),
    answer("A: ODE2, B: ODE4, C: ODE1, D: ODE3", correct = TRUE),
    allow_retry = TRUE
  ))
```

## Model building

The PKPD models are already designed and estimated with other software, such as NONMEM or nlmixr package in R. When you want to simulate with the RxODE package, you need to describe the model with its ODEs, provide the parameter values and the initial values of the compartments. You see these three components for a simple one compartment model with oral dosing in Figure 3. 

```{r fig3, echo = FALSE, out.width = "100%", fig.asp = 0.6, fig.cap = "**Figure 3: Three components of model specification**"}
img <- readPNG("./Images/Model_specify.png")
grid.raster(img)
```

### Model specification

In the previous chapter you have seen different examples of ODEs. It is important that you describe **all** compartments with ODEs in the model specification. ODEs describe the change of amount over time, but often you also want to know the concentration of the central compartment, since this is the concentration that is often measured in the patient. Therefore, you also define the concentration in the model specification, with `C2 = A2/V2`.

Another important aspect of the model definition is the inclusion of the inter individual variability (IIV) on various parameters. IIV describes differences between patients and is often placed on clearance (CL) and/or volume of distribution (V). The typical value (TV) is the same for all patients, and a random value from an eta distribution is added for each patient. For example: `CL = TVCL*exp(eta_CL)`

•	Model parameters (unit, random effect)
•	Initial conditions
•	Covariates


## Simulation

•	eventTable() : dosing and sampling
•	solve the system


## Goal and output

•	Various dosing schemes
•	Different parameters for special populations
